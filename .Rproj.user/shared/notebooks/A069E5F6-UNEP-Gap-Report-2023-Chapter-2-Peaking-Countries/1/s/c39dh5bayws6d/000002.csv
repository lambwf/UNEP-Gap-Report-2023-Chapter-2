"0",""
"0","cons <- openxlsx::read.xlsx('Sources/GCB/National_Fossil_Carbon_Emissions_2022v1.0.xlsx',sheet=3,startRow = 1)"
"0","cons[8,1] <- ""year"""
"0","names(cons) <- cons[8,]"
"0","cons <- cons[9:40,]"
"0",""
"0","cons <- gather(cons,country,value,-year)"
"0","cons <- cons %>% "
"0","  mutate(value=as.numeric(value)) %>% "
"0","  mutate(value=value*3.664*1e6) %>% "
"0","  mutate(iso=countrycode(country,""country.name"",""iso3c"")) %>% "
"0","  mutate(year=as.numeric(year))"
"0",""
"0","data_peaking <- left_join(data_peaking,cons %>% select(iso,year,CO2_cons=value),by = c(""iso"", ""year""))"
"0",""
"0","rates_cons <- data_peaking %>% "
"0","  filter(country==""nothing"") # create empty dataframe "
"0",""
"0","for (i in 1:length(unique(data_peaking$country))) {"
"0","  "
"0","  temp_data <- data_peaking %>% "
"0","    filter(country==unique(data_peaking$country)[i])"
"0","  "
"0","  temp_data <- temp_data %>% "
"0","    filter(year>=temp_data$peak_year[1])"
"0","  "
"0","  ### if peak year is before 1990, calculate rate from 1990 (start of cons data)"
"0","  if (temp_data$peak_year[1]<1990) {"
"0","    "
"0","    temp_data <- temp_data %>% "
"0","      filter(year>=1990)"
"0","    "
"0","  }"
"0","  "
"0","  ### calculate rates to 2019 only"
"0","  "
"0","  temp_data <- temp_data %>% "
"0","    filter(year<2020)"
"0","  "
"0","  ### if there is no cons data, just fill NaNs"
"0","  if (is.na(temp_data$CO2_cons[1])==1) {"
"0","    "
"0","    temp_data$rate_CO2_cons_peak <- NA"
"0","    temp_data$fit_CO2_cons <- NA"
"0","    temp_data$st_error <- NA"
"0","    "
"0","  } else {"
"0","    "
"0","    rates <- growth_rate(temp_data$year,temp_data$CO2_cons)"
"0","    "
"0","    temp_data$rate_CO2_cons_peak <- rates$rate"
"0","    temp_data$fit_CO2_cons <- rates$data$predicted_x"
"0","    temp_data$st_error <- rates$data$st_error"
"0","    "
"0","    rates_cons <- rbind(rates_cons,temp_data)"
"0","    "
"0","  }"
"0","}"
"0",""
"0",""
"0","#rejoin with full data"
"0",""
"0","data_peaking <- left_join(data_peaking,rates_cons %>% ungroup() %>% select(iso,year,rate_CO2_cons_peak,fit_CO2_cons),by = c(""iso"", ""year""))"
"0",""
"0","data_peaking <- data_peaking %>% "
"0","  group_by(country) %>% "
"0","  mutate(rate_CO2_cons_peak=na.locf0(rate_CO2_cons_peak,fromLast=FALSE)) %>% "
"0","  mutate(rate_CO2_cons_peak=na.locf0(rate_CO2_cons_peak,fromLast=TRUE)) %>% "
"0","  mutate(rate_CO2_cons_peak=rate_CO2_cons_peak*100) "
"0",""
"0",""
